<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Source Mapping - Family Constitution Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FB6428',
                        background: '#F6F8FA',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        .arrow {
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 20px solid #10b981;
            margin: 0 auto;
        }
    </style>
</head>
<body class="bg-background min-h-screen py-8 px-4">
    <div class="max-w-5xl mx-auto">

        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="text-3xl">üîç</span>
                    <div>
                        <div class="font-bold text-gray-900 text-xl">How Your Answers Created Your Constitution</div>
                        <div class="text-sm text-gray-600">Transparent mapping from responses to articles</div>
                    </div>
                </div>
                <button onclick="window.location.href='artifacts-view.html'"
                        class="px-4 py-2 border-2 border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-all">
                    ‚Üê Back
                </button>
            </div>
        </div>

        <!-- Mapping Description -->
        <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-6 mb-8">
            <div class="flex items-start gap-4">
                <span class="text-3xl">üìä</span>
                <div>
                    <div class="font-semibold text-gray-900 mb-2">Understanding the Mapping</div>
                    <div class="text-sm text-gray-700">
                        Your Family Constitution was generated from your assessment responses.
                        Below you can see exactly how your Phase 1 scores and Phase 2 answers were transformed
                        into each article of your constitution.
                    </div>
                </div>
            </div>
        </div>

        <!-- Priority Areas Mapping -->
        <div id="mappingContainer">
            <!-- Will be populated dynamically -->
        </div>

        <!-- All Sections Overview -->
        <div class="bg-white rounded-xl shadow-lg p-8">
            <h3 class="text-2xl font-bold text-gray-900 mb-6">Complete Section ‚Üí Article Mapping</h3>
            <div class="text-sm text-gray-600 mb-4">
                All 12 assessment sections contributed to your constitution. Priority areas (marked with ‚≠ê)
                received detailed Phase 2 questions and have more comprehensive content.
            </div>
            <div id="allSectionsContainer" class="space-y-3">
                <!-- Will be populated dynamically -->
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="sections-data.js"></script>
    <script src="phase2-questions.js"></script>
    <script src="storage-utils.js"></script>

    <script>
        let priorityAreas = [];
        let phase1Responses = [];
        let phase2Responses = {};
        let artifacts = null;

        window.addEventListener('DOMContentLoaded', function() {
            priorityAreas = loadPriorityAreas();
            phase1Responses = loadPhase1Responses();
            phase2Responses = loadPhase2Responses();
            artifacts = loadArtifacts();

            if (!artifacts) {
                alert('No constitution found. Please complete the assessment first.');
                window.location.href = 'index.html';
                return;
            }

            renderPriorityMapping();
            renderAllSectionsMapping();
        });

        function renderPriorityMapping() {
            const container = document.getElementById('mappingContainer');
            container.innerHTML = '';

            priorityAreas.forEach((area, idx) => {
                const section = area.section;

                // Get Phase 2 answer preview
                const phase2Answer = getPhase2AnswerPreview(section.id);

                // Get related articles
                const relatedArticles = artifacts.constitution.articles.filter(article =>
                    article.sources.some(source => source.includes(section.title))
                );

                const mappingDiv = document.createElement('div');
                mappingDiv.className = 'bg-white rounded-xl shadow-lg p-8 mb-8';

                let articlesHTML = '';
                relatedArticles.forEach(article => {
                    articlesHTML += `
                        <div class="border-l-4 border-green-500 pl-4 py-2 mb-3">
                            <div class="font-bold text-gray-900 mb-1">
                                Article ${article.number}: ${article.title}
                            </div>
                            <div class="text-sm text-gray-600">
                                ${article.content.substring(0, 150)}...
                            </div>
                        </div>
                    `;
                });

                mappingDiv.innerHTML = `
                    <!-- Section Info -->
                    <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-6 mb-6">
                        <div class="flex items-start gap-4">
                            <span class="text-4xl">${section.icon}</span>
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <div class="font-bold text-xl text-gray-900">${section.title}</div>
                                    <div class="text-xs px-3 py-1 rounded-full font-semibold bg-red-200 text-red-800">
                                        Priority ${idx + 1}
                                    </div>
                                </div>
                                <div class="text-sm text-gray-600 mb-2">${section.description}</div>
                                <div class="text-xs text-gray-500">Phase 1 Score: ${area.score.toFixed(1)}/5.0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Arrow Down -->
                    <div class="text-center mb-6">
                        <div class="text-3xl text-green-500 mb-2">‚Üì</div>
                        <div class="text-xs text-gray-600 font-medium">Phase 2: Your Detailed Answers</div>
                    </div>

                    <!-- Phase 2 Answers -->
                    <div class="bg-green-50 border-2 border-green-200 rounded-xl p-6 mb-6">
                        <div class="font-semibold text-gray-900 mb-3">Your Governance Preferences</div>
                        ${phase2Answer}
                    </div>

                    <!-- Arrow Down -->
                    <div class="text-center mb-6">
                        <div class="text-3xl text-purple-500 mb-2">‚Üì</div>
                        <div class="text-xs text-gray-600 font-medium">AI Generated Constitution Articles</div>
                    </div>

                    <!-- Generated Articles -->
                    <div class="bg-purple-50 border-2 border-purple-200 rounded-xl p-6">
                        <div class="font-semibold text-gray-900 mb-4">Generated from Your Responses:</div>
                        ${articlesHTML || '<div class="text-sm text-gray-600">This section contributed to the overall constitution structure.</div>'}
                    </div>
                `;

                container.appendChild(mappingDiv);
            });
        }

        function getPhase2AnswerPreview(sectionId) {
            const sectionResponses = phase2Responses[sectionId];
            if (!sectionResponses) {
                return '<div class="text-sm text-gray-600 italic">No detailed answers provided for this section.</div>';
            }

            const questions = PHASE2_QUESTIONS[sectionId];
            if (!questions || questions.length === 0) {
                return '<div class="text-sm text-gray-600 italic">No Phase 2 questions for this section.</div>';
            }

            let html = '<div class="space-y-3">';
            questions.slice(0, 1).forEach((question, idx) => {
                const answer = sectionResponses[question.id] || '';
                const preview = answer.length > 200 ? answer.substring(0, 200) + '...' : answer;
                html += `
                    <div>
                        <div class="text-xs font-medium text-gray-700 mb-1">Q: ${question.text}</div>
                        <div class="text-sm text-gray-600 italic">"${preview}"</div>
                    </div>
                `;
            });

            if (questions.length > 1) {
                html += `<div class="text-xs text-gray-500 mt-2">+ ${questions.length - 1} more answer(s)</div>`;
            }

            html += '</div>';
            return html;
        }

        function renderAllSectionsMapping() {
            const container = document.getElementById('allSectionsContainer');
            container.innerHTML = '';

            SECTIONS.forEach((section, idx) => {
                const sectionScore = calculateSectionScore(idx);
                const isPriority = priorityAreas.some(p => p.section.id === section.id);

                // Find related articles
                const relatedArticles = artifacts.constitution.articles
                    .filter(article => article.sources.some(source => source.includes(section.title)))
                    .map(a => `Article ${a.number}`)
                    .join(', ');

                const sectionDiv = document.createElement('div');
                sectionDiv.className = `flex items-center justify-between p-4 rounded-lg ${isPriority ? 'bg-orange-50 border border-orange-200' : 'bg-gray-50'}`;

                sectionDiv.innerHTML = `
                    <div class="flex items-center gap-3 flex-1">
                        <span class="text-2xl">${section.icon}</span>
                        <div class="flex-1">
                            <div class="font-semibold text-gray-900 text-sm flex items-center gap-2">
                                ${section.title}
                                ${isPriority ? '<span class="text-xs">‚≠ê Priority Area</span>' : ''}
                            </div>
                            <div class="text-xs text-gray-600">Score: ${sectionScore.toFixed(1)}/5.0</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-gray-600 font-medium">
                            ${relatedArticles || 'General contribution'}
                        </div>
                    </div>
                `;

                container.appendChild(sectionDiv);
            });
        }

        function calculateSectionScore(sectionIndex) {
            const sectionResponses = phase1Responses[sectionIndex];
            const sum = sectionResponses.reduce((a, b) => a + (b || 0), 0);
            return sum / sectionResponses.length;
        }
    </script>
</body>
</html>
